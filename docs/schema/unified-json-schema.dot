// Unified JSON Schema for Agent History
// Render with: dot -Tpng unified_json_schema.dot -o unified_json_schema.png

digraph UnifiedSchema {
    rankdir=TB;
    node [shape=record, fontname="Helvetica", fontsize=10];
    edge [fontname="Helvetica", fontsize=9];

    // Title
    labelloc="t";
    label="Agent History - Unified NDJSON Schema\n(Streamable Multi-Session Export)";
    fontsize=14;
    fontname="Helvetica-Bold";

    // File structure
    subgraph cluster_file {
        label="NDJSON File Structure";
        style=rounded;
        bgcolor="#f0f0f0";

        file [shape=note, label="export.ndjson\n(one JSON object per line)"];
    }

    // Line types
    subgraph cluster_lines {
        label="Line Types";
        style=rounded;
        bgcolor="#e8f4e8";

        header [label="{Header (line 1)|type: header\lschema_version: string\lexport_timestamp: ISO8601\lagent_types: array\lhomes: array\lsession_count: int\l}"];

        session [label="{Session (lines 2+)|type: session\lsession: object\lmessages: array\l}"];
    }

    // Session object
    subgraph cluster_session {
        label="Session Object";
        style=rounded;
        bgcolor="#e8e8f4";

        session_obj [label="{session|id: string\lagent: string\lworkspace: string\lworkspace_encoded: string\lstarted_at: ISO8601\lended_at: ISO8601\lsource: object\lis_agent_session: bool\lparent_session_id: string?\l}"];
    }

    // Message object
    subgraph cluster_message {
        label="Message Object";
        style=rounded;
        bgcolor="#f4e8e8";

        message [label="{message|index: int\luuid: string?\lparent_uuid: string?\lrole: string\ltimestamp: ISO8601?\lcontent: array\lmetadata: object?\l}"];
    }

    // Content blocks
    subgraph cluster_content {
        label="Content Blocks";
        style=rounded;
        bgcolor="#f4f4e8";

        text_block [label="{TextBlock|type: text\ltext: string\l}"];

        thinking_block [label="{ThinkingBlock|type: thinking\ltext: string\l}"];

        tool_use [label="{ToolUseBlock|type: tool_use\ltool_id: string\ltool_name: string\linput: object\l}"];

        tool_result [label="{ToolResultBlock|type: tool_result\ltool_id: string\ltool_name: string\loutput: string\lis_error: bool\l}"];

        agent_spawn [label="{AgentSpawnBlock|type: agent_spawn\lagent_session_id: string\lprompt: string\lagent_type: string?\l}"];

        agent_result [label="{AgentResultBlock|type: agent_result\lagent_session_id: string\lsummary: string\lis_error: bool\l}"];
    }

    // Metadata
    subgraph cluster_metadata {
        label="Message Metadata";
        style=rounded;
        bgcolor="#f0e8f4";

        metadata [label="{metadata|cwd: string?\lgit_branch: string?\lagent_version: string?\luser_type: string?\lis_meta: bool?\lmodel: object?\ltoken_usage: object?\lrequest_id: string?\l}"];
    }

    // Graph info (optional)
    subgraph cluster_graph {
        label="Graph Info (if forked)";
        style=rounded;
        bgcolor="#e8f0f4";

        graph_info [label="{graph|is_linear: bool\lfork_points: array\lactive_path: array\l}"];
    }

    // Relationships
    file -> header [label="line 1"];
    file -> session [label="lines 2-N"];
    session -> session_obj [label="contains"];
    session -> message [label="contains array"];
    message -> text_block [label="content[]"];
    message -> thinking_block [label="content[]"];
    message -> tool_use [label="content[]"];
    message -> tool_result [label="content[]"];
    message -> agent_spawn [label="content[]"];
    message -> agent_result [label="content[]"];
    message -> metadata [label="optional"];
    session -> graph_info [label="optional\n(forked only)"];
}
